<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Premium</title>
    <style>
        :root{--primary:#D32F2F;--bg:#f4f4f4}
        body{font-family:sans-serif;margin:0;padding:20px;background:var(--bg)}
        h1{color:var(--primary);text-align:center}
        section{background:#fff;padding:20px;border-radius:5px;box-shadow:0 2px 10px rgba(0,0,0,0.1); margin-bottom: 20px;}
        form{display:flex;flex-direction:column;gap:15px;}
        input,select,textarea{padding:12px;border:1px solid #ccc;border-radius:4px;font-size:16px}
        button{background:var(--primary);color:#fff;padding:15px;border:none;cursor:pointer;font-weight:bold;border-radius:4px}
        button:hover{background:#b71c1c}
        button.secondary{background:#555;}
        img.thumb{width:60px;height:60px;object-fit:cover;border-radius:4px}
        img.logo-preview{max-width: 200px; max-height: 100px; object-fit: contain; background: #eee; padding: 10px; border-radius: 4px;}
        #status{display:none;padding:10px;text-align:center;font-weight:bold;margin-bottom:10px;border-radius:4px}
        .success{background:#d4edda;color:#155724} .loading{background:#cce5ff;color:#004085}
        table{width:100%;border-collapse:collapse;margin-top:20px;background:#fff}
        th,td{padding:10px;border:1px solid #ddd;text-align:left}
        th{background:#333;color:white}
    </style>
</head>
<body>
    <h1>Painel CFC Premium</h1>
    <div id="status"></div>
    
    <section id="login-section">
        <form id="loginForm">
            <input type="email" id="login-email" placeholder="Email Administrativo">
            <input type="password" id="login-password" placeholder="Senha">
            <button>Entrar no Sistema</button>
        </form>
    </section>

    <div id="admin-panel" style="display:none">
        
        <section>
            <h3>üì¢ Identidade Visual & Textos</h3>
            <form id="config-form">
                <label>Logo do Site (Deixe vazio para manter o atual):</label>
                <input type="file" id="site-logo-file">
                <img id="current-logo-preview" class="logo-preview" style="display:none">
                
                <hr style="border:0; border-top:1px solid #eee; width:100%">

                <label>Frase Abaixo do Logo (Slogan):</label>
                <input id="site-slogan" placeholder='Ex: "Mais de 20 anos realizando sonhos."'>
                
                <label>T√≠tulo do Banner (Headline):</label>
                <input id="site-headline" placeholder="Ex: Fim da Obrigatoriedade?">
                
                <label>Subt√≠tulo do Banner:</label>
                <input id="site-subheadline" placeholder="Ex: O barato pode custar sua vida...">
                
                <button type="submit" class="secondary">Salvar Configura√ß√µes</button>
            </form>
        </section>

        <section>
            <h3>üöó Cadastrar Novo Servi√ßo</h3>
            <form id="product-form">
                <input type="hidden" id="productId">
                <label>Nome do Servi√ßo:</label>
                <input id="name" placeholder="Ex: Habilita√ß√£o Carro (B)" required>
                <div style="display:flex; gap:10px">
                    <input type="number" id="price" placeholder="Pre√ßo (R$)" required style="flex:1">
                    <select id="secao" required style="flex:1">
                        <option value="">Categoria...</option>
                        <option value="carro">Carro (B)</option>
                        <option value="moto">Moto (A)</option>
                        <option value="combo">Carro + Moto</option>
                        <option value="onibus">√înibus (D)</option>
                        <option value="adicao">Adi√ß√£o</option>
                        <option value="renovacao">Renova√ß√£o</option>
                    </select>
                </div>
                <textarea id="description" rows="3" placeholder="Descri√ß√£o..."></textarea>
                <select id="isFeatured">
                    <option value="nenhum">Normal</option>
                    <option value="destaque">‚≠ê Destaque</option>
                </select>
                <input type="file" id="imageUrl">
                <button type="submit">Salvar Servi√ßo</button>
                <button type="button" id="cancel-edit-btn" style="display:none;background:#777">Cancelar Edi√ß√£o</button>
            </form>
        </section>

        <section>
            <h3>Servi√ßos Ativos</h3>
            <div style="overflow-x:auto">
                <table id="products-table">
                    <thead><tr><th>Foto</th><th>Servi√ßo</th><th>Valor</th><th>A√ß√µes</th></tr></thead>
                    <tbody id="products-list"></tbody>
                </table>
            </div>
            <button id="btnLogout" style="margin-top:20px;background:#333">Sair</button>
        </section>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script> 
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script> 
    <script>
        const CLOUDINARY_URL="https://api.cloudinary.com/v1_1/dlsxwrkks/auto/upload"; 
        const UPLOAD_PRESET="da1soqf5";
        const firebaseConfig={apiKey:"AIzaSyAGXoIZh1tPLbpQ62MKw1NkXxboIg5cbMk",authDomain:"auto-escola-premium.firebaseapp.com",projectId:"auto-escola-premium",storageBucket:"auto-escola-premium.firebasestorage.app",messagingSenderId:"100515126742",appId:"1:100515126742:web:88069eb81308bded8e1877"};
        firebase.initializeApp(firebaseConfig); 
        const db=firebase.firestore(); 
        const auth=firebase.auth();
        
        async function uploadFile(f){
            const fd=new FormData(); fd.append('file',f); fd.append('upload_preset',UPLOAD_PRESET);
            const r=await fetch(CLOUDINARY_URL,{method:'POST',body:fd}); const d=await r.json(); return d.secure_url;
        }
        
        function showStatus(m,t='loading'){const s=document.getElementById('status');s.textContent=m;s.className=t;s.style.display='block';setTimeout(()=>s.style.display='none',3000)}

        document.addEventListener('DOMContentLoaded',()=>{
            let currentLogoUrl = ''; // Guarda a URL atual do logo

            document.getElementById('loginForm').addEventListener('submit',async(e)=>{
                e.preventDefault();
                try{await auth.signInWithEmailAndPassword(document.getElementById('login-email').value,document.getElementById('login-password').value)}
                catch(e){alert("Erro: "+e.message)}
            });
            
            auth.onAuthStateChanged(u=>{
                if(u){
                    document.getElementById('login-section').style.display='none';
                    document.getElementById('admin-panel').style.display='block';
                    loadProducts();
                    loadConfig();
                }
            });

            // CARREGA CONFIGURA√á√ïES DO FIREBASE
            async function loadConfig(){
                try {
                    const doc = await db.collection('config').doc('site_texts').get();
                    if(doc.exists){
                        const data = doc.data();
                        document.getElementById('site-slogan').value = data.slogan || '';
                        document.getElementById('site-headline').value = data.headline || '';
                        document.getElementById('site-subheadline').value = data.subheadline || '';
                        
                        if(data.logoUrl) {
                            currentLogoUrl = data.logoUrl;
                            const preview = document.getElementById('current-logo-preview');
                            preview.src = data.logoUrl;
                            preview.style.display = 'block';
                        }
                    }
                } catch(e){console.log("Sem config");}
            }

            // SALVA CONFIGURA√á√ïES (TEXTO + LOGO)
            document.getElementById('config-form').addEventListener('submit', async(e)=>{
                e.preventDefault();
                showStatus("Salvando configura√ß√µes...");
                
                let newLogoUrl = currentLogoUrl;
                const logoFile = document.getElementById('site-logo-file').files[0];
                
                // Se o usu√°rio selecionou um arquivo novo, faz upload
                if(logoFile) {
                    showStatus("Enviando logo para Cloudinary...");
                    newLogoUrl = await uploadFile(logoFile);
                }

                const slogan = document.getElementById('site-slogan').value;
                const h = document.getElementById('site-headline').value;
                const s = document.getElementById('site-subheadline').value;
                
                await db.collection('config').doc('site_texts').set({
                    logoUrl: newLogoUrl, // Salva a URL do logo
                    slogan: slogan,
                    headline: h,
                    subheadline: s
                });
                
                // Atualiza a visualiza√ß√£o
                currentLogoUrl = newLogoUrl;
                const preview = document.getElementById('current-logo-preview');
                preview.src = newLogoUrl;
                preview.style.display = 'block';
                document.getElementById('site-logo-file').value = ''; // Limpa o input

                showStatus("Site atualizado com sucesso!", "success");
            });

            document.getElementById('btnLogout').addEventListener('click',()=>auth.signOut().then(()=>location.reload()));
            let oldImg='';

            async function loadProducts(){
                const l=document.getElementById('products-list');l.innerHTML='';
                (await db.collection("products").orderBy("createdAt","desc").get()).forEach(d=>{
                    const p=d.data(); 
                    l.innerHTML+=`<tr><td><img src="${p.imageUrl}" class="thumb"></td><td>${p.name}<br><small>${p.secao}</small></td><td>R$ ${p.price}</td><td><button onclick="edit('${d.id}')" style="background:#007bff;padding:5px">‚úèÔ∏è</button> <button onclick="del('${d.id}')" style="background:#dc3545;padding:5px">üóëÔ∏è</button></td></tr>`;
                });
            }

            document.getElementById('product-form').addEventListener('submit',async(e)=>{
                e.preventDefault(); showStatus("Salvando produto...");
                try{
                    let img=oldImg; const f=document.getElementById('imageUrl').files[0]; if(f) img=await uploadFile(f);
                    const d={
                        name:document.getElementById('name').value, price:parseFloat(document.getElementById('price').value), 
                        secao:document.getElementById('secao').value, description:document.getElementById('description').value, 
                        isFeatured:document.getElementById('isFeatured').value, imageUrl:img, createdAt:firebase.firestore.FieldValue.serverTimestamp()
                    };
                    const id=document.getElementById('productId').value||`srv_${Date.now()}`;
                    await db.collection("products").doc(id).set(d,{merge:true});
                    document.getElementById('product-form').reset(); document.getElementById('productId').value=''; oldImg=''; 
                    document.getElementById('cancel-edit-btn').style.display='none';
                    loadProducts(); showStatus("Produto salvo!","success");
                }catch(err){showStatus("Erro: "+err.message,"error")}
            });

            window.edit=async(id)=>{
                const d=await db.collection("products").doc(id).get();const p=d.data();
                document.getElementById('productId').value=id; document.getElementById('name').value=p.name;
                document.getElementById('price').value=p.price; document.getElementById('secao').value=p.secao;
                document.getElementById('description').value=p.description; document.getElementById('isFeatured').value=p.isFeatured;
                oldImg=p.imageUrl; document.getElementById('cancel-edit-btn').style.display='inline'; window.scrollTo(0,0);
            };
            document.getElementById('cancel-edit-btn').addEventListener('click',()=>{document.getElementById('product-form').reset();document.getElementById('cancel-edit-btn').style.display='none'});
            window.del=async(id)=>{if(confirm("Apagar?"))await db.collection("products").doc(id).delete();loadProducts()};
        });
    </script>
</body>
</html>
